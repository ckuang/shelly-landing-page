<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelly</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">

</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">Shelly</h1>
        </header>
        
        <main>
            <section class="content">
                <p class="text coming-soon">
                    Coming soon
                </p>
                
                <p class="caption">
                    Get updates on our launch â€” subscribe below!
                </p>
                
                <form class="email-form" id="email-form">
                    <input type="email" id="email" placeholder="Enter Your Email Address" required>
                    <input type="hidden" id="session_id" name="session_id" value="">
                    <input type="hidden" id="csrf_token" name="csrf_token" value="">
                    <button type="submit" class="submit-btn" id="submit-button">Submit</button>
                </form>
                <div id="response-message" class="success-message">
                    Thank you for subscribing! We'll keep you updated.
                </div>
            </section>
        </main>
    </div>
    
    <script>
    // 1. CONFIGURATION
    // Replace with your Google Apps Script web app URL
    const scriptURL = 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL';
    
    // Get the current origin
    const origin = window.location.origin;
    
    // 2. JSONP HELPER FUNCTIONS
    // Function to load data via JSONP
    function loadJSONP(url, callback) {
      return new Promise((resolve, reject) => {
        // Create a unique callback name
        const callbackName = 'jsonp_callback_' + Math.random().toString(36).substr(2, 9);
        
        // Set up the callback function that the JSONP response will call
        window[callbackName] = function(data) {
          resolve(data);
          // Clean up
          document.head.removeChild(script);
          delete window[callbackName];
        };
        
        // Create the script element to make the JSONP request
        const script = document.createElement('script');
        
        // Add callback parameter to the URL
        const separator = url.indexOf('?') !== -1 ? '&' : '?';
        script.src = `${url}${separator}callback=${callbackName}`;
        
        // Handle errors
        script.onerror = () => {
          reject(new Error('JSONP request failed'));
          document.head.removeChild(script);
          delete window[callbackName];
        };
        
        // Set timeout to handle hanging requests
        const timeoutId = setTimeout(() => {
          reject(new Error('JSONP request timed out'));
          if (script.parentNode) document.head.removeChild(script);
          delete window[callbackName];
        }, 10000);
        
        // Add the script to the document to start the request
        document.head.appendChild(script);
      });
    }
    
    // 3. SESSION INITIALIZATION
    // Function to initialize a secure session
    async function initializeSession() {
      const responseElement = document.getElementById('response-message');
      
      try {
        // Show loading message
        responseElement.innerHTML = 'Loading...';
        responseElement.style.color = '#666';
        
        // Disable form until session is established
        document.getElementById('submit-button').disabled = true;
        
        // Create JSONP URL to request a new session
        const sessionUrl = `${scriptURL}?createSession=true&origin=${encodeURIComponent(origin)}`;
        
        // Make the JSONP request
        console.log('Requesting session...');
        const response = await loadJSONP(sessionUrl);
        console.log('Session response:', response);
        
        // Check for errors
        if (response.result === 'error') {
          throw new Error(response.message || 'Failed to create session');
        }
        
        // Store the session data in the form
        document.getElementById('session_id').value = response.sessionId;
        document.getElementById('csrf_token').value = response.csrfToken;
        
        // Enable the form
        document.getElementById('submit-button').disabled = false;
        responseElement.innerHTML = '';
        
      } catch (error) {
        // Handle errors
        console.error('Session initialization error:', error);
        responseElement.innerHTML = 'Error loading form. Please refresh and try again.';
        responseElement.style.color = '#F44336';
      }
    }
    
    // 4. FORM SUBMISSION
    // Handle form submission
    document.getElementById('email-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const token = document.getElementById('csrf_token').value;
      const sessionId = document.getElementById('session_id').value;
      const responseElement = document.getElementById('response-message');
      
      // Verify we have session and token
      if (!token || !sessionId) {
        responseElement.innerHTML = 'Security session missing. Please refresh the page.';
        responseElement.style.color = '#F44336';
        return;
      }
      
      // Show loading message
      responseElement.innerHTML = 'Submitting...';
      responseElement.style.color = '#666';
      
      try {
        // Create JSONP URL for submission
        const submitUrl = `${scriptURL}?email=${encodeURIComponent(email)}&csrf_token=${encodeURIComponent(token)}&session_id=${encodeURIComponent(sessionId)}&origin=${encodeURIComponent(origin)}`;
        
        // Submit via JSONP
        const response = await loadJSONP(submitUrl);
        console.log('Submission response:', response);
        
        // Handle response
        if (response.result === 'success') {
          responseElement.innerHTML = 'Thank you for subscribing!';
          responseElement.style.color = '#4CAF50';
          document.getElementById('email').value = '';
        } else {
          throw new Error(response.message || 'Submission failed');
        }
      } catch (error) {
        // Handle errors
        console.error('Submission error:', error);
        responseElement.innerHTML = 'Something went wrong. Please try again.';
        responseElement.style.color = '#F44336';
      }
    });
    
    // 5. INITIALIZE
    // Initialize session when page loads
    document.addEventListener('DOMContentLoaded', initializeSession);
    </script>
</body>
</html>
